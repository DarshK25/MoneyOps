spring:
  application:
    name: api-gateway

  # Redis Configuration
  data:
    redis:
      host: ${REDIS_HOST:localhost}
      port: ${REDIS_PORT:6379}
      password: ${REDIS_PASSWORD:}
      timeout: 2000ms
      lettuce:
        pool:
          max-active: 8
          max-idle: 8
          min-idle: 2

  # Lifecycle Configuration
  lifecycle:
    timeout-per-shutdown-phase: 20s
  
  cloud:
    gateway:
      # Global CORS configuration
      globalcors:
        cors-configurations:
          '[/**]':
            allowedOriginPatterns: "*"
            allowedMethods:
              - GET
              - POST
              - PUT
              - DELETE
              - PATCH
              - OPTIONS
            allowedHeaders: "*"
            allowCredentials: true
            maxAge: 3600
      
      # Route definitions
      routes:
        # ============================================
        # AUTH ROUTES (Public - No JWT validation)
        # ============================================
        - id: auth-login
          uri: ${backend.core.url}
          predicates:
            - Path=/api/auth/login
            - Method=POST
          filters:
            - name: RequestRateLimiter
              args:
                key-resolver: "#{@ipKeyResolver}"
        
        - id: auth-register
          uri: ${backend.core.url}
          predicates:
            - Path=/api/auth/register
            - Method=POST
          filters:
            - name: RequestRateLimiter
              args:
                key-resolver: "#{@ipKeyResolver}"
        
        # Token refresh requires valid JWT
        - id: auth-refresh
          uri: ${backend.core.url}
          predicates:
            - Path=/api/auth/refresh
            - Method=POST
        
        # ============================================
        # USER ROUTES (Authenticated)
        # ============================================
        - id: users-routes
          uri: ${backend.core.url}
          predicates:
            - Path=/api/users/**
          filters:
            - name: RequestRateLimiter
              args:
                key-resolver: "#{@userKeyResolver}"
        
        # ============================================
        # ORGANIZATION ROUTES (Authenticated + Tenant)
        # ============================================
        - id: organizations-routes
          uri: ${backend.core.url}
          predicates:
            - Path=/api/organizations/**
          filters:
            - name: RequestRateLimiter
              args:
                key-resolver: "#{@orgKeyResolver}"
        
        # ============================================
        # CLIENT ROUTES (Authenticated + Tenant)
        # ============================================
        - id: clients-routes
          uri: ${backend.core.url}
          predicates:
            - Path=/api/clients/**
          filters:
            - name: RequestRateLimiter
              args:
                key-resolver: "#{@orgKeyResolver}"
        
        # ============================================
        # INVOICE ROUTES (Authenticated + Tenant)
        # ============================================
        - id: invoices-routes
          uri: ${backend.core.url}
          predicates:
            - Path=/api/invoices/**
          filters:
            - name: RequestRateLimiter
              args:
                key-resolver: "#{@orgKeyResolver}"
        
        # ============================================
        # TRANSACTION ROUTES (Authenticated + Tenant)
        # ============================================
        - id: transactions-routes
          uri: ${backend.core.url}
          predicates:
            - Path=/api/transactions/**
          filters:
            - name: RequestRateLimiter
              args:
                key-resolver: "#{@orgKeyResolver}"
        
        # ============================================
        # DOCUMENT ROUTES (Authenticated + Tenant)
        # ============================================
        - id: documents-routes
          uri: ${backend.core.url}
          predicates:
            - Path=/api/documents/**
          filters:
            - name: RequestRateLimiter
              args:
                key-resolver: "#{@orgKeyResolver}"
        
        # ============================================
        # AI GATEWAY ROUTES (Authenticated + Tenant)
        # ============================================
        - id: ai-chat-routes
          uri: ${ai.gateway.url}
          predicates:
            - Path=/api/ai/chat/**
          filters:
            - name: RequestRateLimiter
              args:
                key-resolver: "#{@orgKeyResolver}"
        
        - id: ai-voice-routes
          uri: ${ai.gateway.url}
          predicates:
            - Path=/api/ai/voice/**
          filters:
            - name: RequestRateLimiter
              args:
                key-resolver: "#{@orgKeyResolver}"
        
        # ============================================
        # VOICE SERVICE ROUTES (Authenticated + Tenant)
        # ============================================
        - id: voice-service-routes
          uri: ${voice.service.url}
          predicates:
            - Path=/api/voice/**
          filters:
            - name: RequestRateLimiter
              args:
                key-resolver: "#{@orgKeyResolver}"

# ============================================
# DOWNSTREAM SERVICE URLs
# ============================================
backend:
  core:
    url: http://localhost:8000

ai:
  gateway:
    url: http://localhost:8001

voice:
  service:
    url: http://localhost:8002

# ============================================
# JWT CONFIGURATION
# ============================================
jwt:
  secret: ${JWT_SECRET:your-256-bit-secret-your-256-bit-secret-your-256-bit-secret-your-256-bit-secret}
  expiration: 86400000  # 24 hours in milliseconds

# ============================================
# GATEWAY CONFIGURATION
# ============================================
gateway:
  # Public endpoints (no JWT validation)
  public-endpoints: /api/auth/login,/api/auth/register,/actuator/health,/actuator/ready
  
  # Tenant isolation configuration
  tenant:
    enforce-isolation: true
    required-paths: /api/clients/**,/api/invoices/**,/api/transactions/**,/api/documents/**,/api/organizations/**
  
  # Request logging
  logging:
    enabled: true
    log-request-body: false  # Security: Don't log sensitive data
    log-response-body: false
    slow-request-threshold-ms: 3000  # Log requests slower than 3 seconds

# ============================================
# REDIS CONFIGURATION (for Rate Limiting - Phase 3)
# ============================================
# Redis configuration moved to top

# ============================================
# ACTUATOR (Health Checks)
# ============================================
management:
  endpoints:
    web:
      exposure:
        include: health,info,gateway
      base-path: /actuator
  endpoint:
    health:
      show-details: always
      probes:
        enabled: true
  health:
    redis:
      enabled: false
    readiness-state:
      enabled: true
    liveness-state:
      enabled: true

# ============================================
# LOGGING CONFIGURATION
# ============================================
logging:
  level:
    root: INFO
    com.moneyops.gateway: DEBUG
    org.springframework.cloud.gateway: DEBUG
    org.springframework.security: INFO
  pattern:
    console: "%d{yyyy-MM-dd HH:mm:ss} [%thread] %-5level %logger{36} - %msg%n"

# ============================================
# SERVER CONFIGURATION
# ============================================
server:
  port: ${PORT:8003}
  shutdown: graceful
  error:
    include-message: always
    include-binding-errors: always
    include-stacktrace: never
    include-exception: false

# Graceful shutdown timeout
# Lifecycle configuration moved to top